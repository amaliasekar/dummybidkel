<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Pendataan Kelautan</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family: sans-serif; }
    #map { height:100%; }
    #form-container {
      position:absolute;
      top:10px; right:10px;
      background:white; padding:15px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      z-index:1000;
      width:300px;
      display:none;
      max-height: calc(100% - 40px);
      overflow-y: auto;
    }
    label { display:block; margin-top:10px; font-weight:bold; font-size: 14px; }
    select, input, textarea, button { 
      width:100%; 
      margin-top:5px; 
      padding:8px; 
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 15px;
      padding: 10px;
    }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

<div id="map"></div>

<div id="form-container">
  <form id="data-form">
    <h3>Input Data Lapangan</h3>

    <label for="jenis">Jenis Data</label>
    <select id="jenis" name="jenis" required>
      <option value="">-- Pilih Jenis Data --</option>
      <option value="Pendataan_Resort">Pendataan_Resort</option>
      <option value="Pendataan_Biota">Pendataan_Biota</option>
      <option value="Pendataan_Biofisik">Pendataan_Biofisik</option>
      <option value="Penemuan_Biota">Penemuan_Biota</option>
      <option value="Pelanggaran">Pelanggaran</option>
    </select>

    <input type="hidden" id="timestamp">
    <div id="extra-fields"></div>

    <label for="tgl">Tanggal_Ditemukan</label>
    <input type="date" id="tgl" required>

    <label for="lat">Latitude</label>
    <input type="text" id="lat" required>

    <label for="lng">Longitude</label>
    <input type="text" id="lng" required>

    <label for="foto">Foto Dokumentasi (opsional, maks 10MB)</label>
    <input type="file" id="foto" accept="image/*">

    <button type="button" id="submit-btn" onclick="submitData()">Kirim Data</button>
  </form>
</div>

<script>
  // GANTI DENGAN URL WEB APP BARU SETELAH DEPLOY ULANG
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby6LZCSkvfdOujRQotl2bkdfNa7my92y474nE_sONbSEXSHWKMx0CgyOckGUKyR1kkO/exec";
  const DASHBOARD_URL = "https://lookerstudio.google.com/reporting/dc15387a-3237-4b62-b910-b52de050d507";

  var map = L.map('map').setView([3.1051, 106.2548], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  var timestampInput = document.getElementById("timestamp");
  var formContainer = document.getElementById("form-container");
  var latInput = document.getElementById("lat");
  var lngInput = document.getElementById("lng");
  var dataForm = document.getElementById("data-form");
  var currentMarker = null;

  // Event klik peta: Tampilkan form, isi koordinat, tambah marker
  map.on('click', function(e){
    formContainer.style.display = "block";
    dataForm.reset();
    document.getElementById("extra-fields").innerHTML = "";

    // Isi latitude dan longitude
    latInput.value = e.latlng.lat.toFixed(6);
    lngInput.value = e.latlng.lng.toFixed(6);

    // Buat timestamp
    const now = new Date();
    const localTimestamp = now.toLocaleString("id-ID", {
      timeZone: "Asia/Jakarta",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    }).replace(/,/, "");
    timestampInput.value = localTimestamp;

    // Hapus marker lama, tambah marker baru
    if (currentMarker) {
      map.removeLayer(currentMarker);
    }
    currentMarker = L.marker(e.latlng).addTo(map);
  });

  // Field dinamis (sama seperti sebelumnya)
  document.getElementById("jenis").addEventListener("change", function() {
    const jenis = this.value;
    const extra = document.getElementById("extra-fields");
    extra.innerHTML = "";
    if (jenis === "Pendataan_Resort") {
      extra.innerHTML = `
        <label for="pengisidata">Pengisi Data</label><input type="text" id="pengisidata">
        <label for="namausaha">Nama Usaha</label><input type="text" id="namausaha">
        <label for="nib">NIB</label><input type="number" id="nib">
        <label for="alamatkantor">Alamat Kantor</label><textarea id="alamatkantor" rows="3"></textarea>
        <label for="contactperson">Contact Person</label><input type="text" id="contactperson">
        <label for="namapemilikusaha">Nama Pemilik Usaha</label><input type="text" id="namapemilikusaha">
        <label for="statuskepemilikanmodal">Status Kepemilikan Modal</label><input type="text" id="statuskepemilikanmodal">
        <label for="namapulau">Nama Pulau</label><input type="text" id="namapulau">
        <label for="luaspulau">Luas Pulau (km2)</label><input type="number" id="luaspulau">
        <label for="luasusaha">Luas Usaha di Pulau (hektar)</label><input type="number" id="luasusaha">
        <label for="rtrw">Kesesuaian RTRW dan Lokasi Usaha</label><textarea id="rtrw" rows="2"></textarea>
        <label for="buktikepemilikan">Bukti Kepemilikan</label><textarea id="buktikepemilikan" rows="2"></textarea>
        <label for="statuskawasan">Status Kawasan</label><input type="text" id="statuskawasan">
        <label for="pkkpr">Izin Lokasi PKKPR</label><input type="text" id="pkkpr">
        <label for="izinlingkungan">Izin Lingkungan</label><input type="text" id="izinlingkungan">
        <label for="imb">IMB</label><input type="text" id="imb">
        <label for="pkkpma">Izin Pemanfaatan PPK dalam rangka PMA</label><textarea id="pkkpma" rows="2"></textarea>
        <label for="pkkpmdn">Rekomendasi PPK dengan luas dibawah 100 km2 (PMDN)</label><textarea id="pkkpmdn" rows="2"></textarea>
        <label for="kbli">Izin usaha berbasis KBLI</label><input type="text" id="kbli">
        <label for="lainnya">Izin usaha lainnya</label><input type="text" id="lainnya">
        <label for="pkkprl">Izin PKKPRL</label><input type="text" id="pkkprl">
        <label for="gambaranekosistem">Gambaran Umum Ekosistem Pulau</label><input type="text" id="gambaranekosistem">
        <label for="ekosistemteresterial">Ekosistem Teresterial</label><input type="text" id="ekosistemteresterial">
        <label for="faunadipulau">Fauna di pulau dan sekitarnya</label><input type="text" id="faunadipulau">
        <label for="jmlpenduduk">Jumlah Penduduk</label><input type="number" id="jmlpenduduk">
        <label for="situsbudaya">Situs Budaya</label><input type="text" id="situsbudaya">
        <label for="situsagama">Situs Agama</label><input type="text" id="situsagama">
        <label for="dampaksosial">Dampak Sosial</label><input type="text" id="dampaksosial">
        <label for="pencarianmsy">Mata Pencaharian Masyarakat Pulau</label><input type="text" id="pencarianmsy">
        <label for="jmltk">Jumlah Tenaga Kerja yang Terlibat</label><input type="number" id="jmltk">
        <label for="dampakekonomi">Dampak Ekonomi Masyarakat Pulau</label><input type="text" id="dampakekonomi">
        <label for="hankam">Informasi keberadaan petugas hankam di sekitar pulau</label><input type="text" id="hankam">
      `;
    } else if (jenis === "Pendataan_Biota") {
      extra.innerHTML = `<label for="jenisBiota">Jenis Biota</label><select id="jenisBiota"><option value="">--Pilih--</option><option value="Penyu">Penyu</option><option value="Cetacea">Cetacea</option></select><div id="sub-biota"></div>`;
      // Event listener untuk sub-biota (sama seperti sebelumnya)
      const jenisBiotaSelect = document.getElementById("jenisBiota");
      if (jenisBiotaSelect) {
        jenisBiotaSelect.addEventListener("change", function() {
          const sub = document.getElementById("sub-biota");
          sub.innerHTML = "";
          if (this.value === "Penyu") {
            sub.innerHTML = `
              <label for="pengisidata">Pengisi Data</label><input type="text" id="pengisidata">
              <label for="jmljejak">Jumlah temuan jejak</label><input type="number" id="jmljejak">
              <label for="jmlsarangpalsu">Jumlah temuan sarang palsu</label><input type="number" id="jmlsarangpalsu">
              <label for="jmlsarangbertelur">Jumlah temuan sarang bertelur</label><input type="number" id="jmlsarangbertelur">
              <label for="jmlsarangutuh">Jumlah sarang utuh</label><input type="number" id="jmlsarangutuh">
              <label for="jmlsarangrusakmns">Jumlah sarang rusak manusia</label><input type="number" id="jmlsarangrusakmns">
              <label for="jmlsarangrusakpred">Jumlah sarang rusak predator</label><input type="number" id="jmlsarangrusakpred">
              <label for="kedsarmin">Kedalaman sarang minimum</label><input type="number" id="kedsarmin">
              <label for="kedsarmax">Kedalaman sarang maksimum</label><input type="number" id="kedsarmax">
              <label for="jmlsarphijau">Jumlah sarang penyu hijau</label><input type="number" id="jmlsarphijau">
              <label for="jmlsarpsisik">Jumlah sarang penyu sisik</label><input type="number" id="jmlsarpsisik">
              <label for="jmltlrphijau">Jumlah telur penyu hijau</label><input type="number" id="jmltlrphijau">
              <label for="jmltlrpsisik">Jumlah telur penyu sisik</label><input type="number" id="jmltlrpsisik">
            `;
          } else if (this.value === "Cetacea") {
            sub.innerHTML = `
              <label for="pengisidata">Pengisi Data</label><input type="text" id="pengisidata">
              <label for="family">Family</label><input type="text" id="family">
              <label for="genus">Genus</label><input type="text" id="genus">
              <label for="species">Species</label><input type="text" id="species">
              <label for="namaumum">Nama Umum</label><input type="text" id="namaumum">
              <label for="namaina">Nama Indonesia</label><input type="text" id="namaina">
              <label for="kondkemunculan">Kondisi kemunculan</label><input type="text" id="kondkemunculan">
              <label for="jmltemuan">Jumlah temuan</label><input type="number" id="jmltemuan">
              <label for="tipeobs">Tipe observasi</label><input type="text" id="tipeobs">
              <label for="kondcuaca">Kondisi cuaca</label><input type="text" id="kondcuaca">
              <label for="kondair">Kondisi perairan</label><input type="text" id="kondair">
              <label for="kondangin">Kondisi angin</label><input type="text" id="kondangin">
              <label for="reaksi">Reaksi cetacean</label><input type="text" id="reaksi">
              <label for="aktivitas">Aktivitas</label><input type="text" id="aktivitas">
              <label for="sumberdata">Sumber data</label><input type="text" id="sumberdata">
              <label for="deskripsi">Deskripsi</label><input type="text" id="deskripsi">
            `;
          }
        });
      }
    } else if (jenis === "Pendataan_Biofisik") {
      extra.innerHTML = `
        <label for="jenisBiofisik">Jenis Biofisik</label>
        <select id="jenisBiofisik">
          <option value="">--Pilih--</option>
          <option value="terumbu">Terumbu Karang</option>
          <option value="ikankarang">Ikan Karang</option>
          <option value="megabenthos">Megabenthos</option>
          <option value="mangrove">Mangrove</option>
          <option value="lamun">Lamun</option>
          <option value="rehabilitasi">Rehabilitasi</option>
          <option value="sebaranbantuan">Sebaran Bantuan Pemerintah</option>
        </select>
        <div id="sub-biofisik"></div>
      `;
      const jenisBiofisikSelect = document.getElementById("jenisBiofisik");
      if (jenisBiofisikSelect) {
        jenisBiofisikSelect.addEventListener("change", function() {
          const sub = document.getElementById("sub-biofisik");
          sub.innerHTML = "";
          if (this.value === "mangrove") {
            sub.innerHTML = `<label for="luasMangrove">Luas Mangrove (ha)</label><input type="number" id="luasMangrove"><label for="kondisiMangrove">Kondisi Mangrove</label><input type="text" id="kondisiMangrove">`;
          } else if (this.value === "terumbu") {
            sub.innerHTML = `<label for="persenTutup">% Tutupan</label><input type="number" id="persenTutup"><label for="kondisiTerumbu">Kondisi Terumbu</label><input type="text" id="kondisiTerumbu">`;
          } else if (this.value === "ikankarang") {
            sub.innerHTML = `<label for="jumlahSpesies">Jumlah Spesies</label><input type="number" id="jumlahSpesies"><label for="kepadatan">Kepadatan</label><input type="text" id="kepadatan">`;
          }
        });
      }
    } else if (jenis === "Pelanggaran") {
      extra.innerHTML = `<label for="jenisPelanggaran">Jenis Aktivitas</label><select id="jenisPelanggaran"><option value="Penangkapan Ikan">Penangkapan Ikan</option><option value="Labuh Jangkar">Labuh Jangkar</option><option value="Penambangan">Penambangan</option></select><label for="zona">Zona Pelanggaran</label><input type="text" id="zona">`;
    }
  });

  // Fungsi submit data dengan mode 'no-cors' untuk atasi CORS
  async function submitData() {
    const submitBtn = document.getElementById('submit-btn');
    const jenis = document.getElementById("jenis").value;
    const lat = document.getElementById("lat").value;
    const lng = document.getElementById("lng").value;
    const tgl = document.getElementById("tgl").value;
    const foto = document.getElementById("foto").files[0];

    // Validasi
    if (!jenis) {
      alert("Silakan pilih Jenis Data terlebih dahulu.");
      return;
    }
    if (!tgl) {
      alert("Silakan isi Tanggal Ditemukan.");
      return;
    }
    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
      alert("Latitude dan Longitude harus diisi dengan nilai numerik.");
      return;
    }
    if (foto && foto.size > 10 * 1024 * 1024) {
      alert("Ukuran foto terlalu besar (maks 10MB).");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Mengirim...";

    // Buat FormData
    const formData = new FormData();
    formData.append('sheet', jenis);
    formData.append('Timestamp', timestampInput.value);
    formData.append('Tanggal_Ditemukan', tgl);
    formData.append('Latitude', lat);
    formData.append('Longitude', lng);

    // Ambil data lain
    const allLabeledInputs = dataForm.querySelectorAll("input[id], select[id], textarea[id]");
    allLabeledInputs.forEach(el => {
      if (el.id !== 'timestamp' && el.id !== 'tgl' && el.id !== 'lat' && el.id !== 'lng' && el.id !== 'foto' && el.value) {
        const label = dataForm.querySelector(`label[for='${el.id}']`);
        if (label) {
          formData.append(label.textContent, el.value);
        }
      }
    });

    // Tambah foto
    if (foto) {
      formData.append('foto', foto);
    }

    // Kirim dengan no-cors untuk atasi blokir CORS
    fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData,
      mode: 'no-cors'  // Ini kunci: Izinkan request tanpa baca respons
    }).then(() => {
      // Asumsikan sukses karena no-cors tidak bisa cek respons
      alert("Data berhasil terkirim! (Cek Sheets/Drive untuk konfirmasi). Anda akan diarahkan ke dashboard dalam 1 detik.");
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
      dataForm.reset();
      formContainer.style.display = "none";
      setTimeout(() => {
        window.location.href = DASHBOARD_URL;
      }, 1000);
    }).catch((error) => {
      console.error('Error:', error);
      alert("Gagal mengirim data (mungkin masalah jaringan). Coba lagi atau cek console.");
      submitBtn.disabled = false;
      submitBtn.textContent = "Kirim Data";
    });
  }
</script>
</body>
</html>

